<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¯ÙØ¹ - FAST NET</title>
<style>
/* ===== Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØµÙØ­Ø© ===== */
body { 
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif; 
    padding:20px; 
    direction:rtl; 
    background: linear-gradient(135deg, #f0f4ff, #f9fafc);
    color:#333;
}
h1 { 
    text-align:center; 
    margin-bottom:25px; 
    color:#1a237e;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* ===== Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© ===== */
.back-btn { 
    background-color: #1a237e; 
    color: white; 
    padding: 15px 35px; 
    margin-bottom:20px; 
    font-size: 20px; 
    font-weight: bold; 
    border-radius: 8px; 
    cursor: pointer; 
    border: none; 
    transition: background 0.3s, transform 0.2s; 
    display: inline-block;
}
.back-btn:hover { 
    background-color: #283593; 
    transform: translateY(-2px);
}
@media screen and (max-width: 600px) {
    .back-btn { width: 100%; text-align: center; }
}

/* ===== Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© ===== */
#search, #filterStatus { 
    padding:10px 12px; 
    width:100%; 
    max-width:400px; 
    display:block; 
    margin:12px auto; 
    border-radius:6px; 
    border:1px solid #bbb; 
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    font-size: 16px; 
}

/* ===== Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
table { 
    width:100%; 
    border-collapse:collapse; 
    margin-top:15px; 
    background:white; 
    box-shadow:0 4px 10px rgba(0,0,0,0.05); 
    border-radius:8px; 
    overflow:hidden;
}
th, td { 
    padding:12px 10px; 
    border:1px solid #ddd; 
    text-align:center; 
    font-size:20px; 
}
th { 
    background-color:#007bff; 
    color:white; 
    font-weight:600;
    font-size:17px; 
}
td { background:white; }

/* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ===== */
button { 
    padding:8px 14px; 
    cursor:pointer; 
    margin:2px; 
    border-radius:6px; 
    border:none; 
    font-size:15px; 
    font-weight:bold;
    transition:0.2s all;
}
button:hover { opacity:0.85; transform:translateY(-1px); }

.pay-btn { background-color:#ffc107; color:white; }
.print-btn { background-color:#28a745; color:white; }
.wa-btn { background-color:#25d366; color:white; }

/* ===== Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø© ===== */
.status-paid { 
    background-color: #388e3c; 
    color: white; 
    font-weight: bold; 
    border-radius: 10px; 
    padding: 8px 14px; 
    display:inline-block;
}
.status-partial { 
    background-color: #f57c00; 
    color: white; 
    font-weight: bold; 
    border-radius: 10px; 
    padding: 8px 14px; 
    display:inline-block;
}
.status-unpaid { 
    background-color: #c62828; 
    color: white; 
    font-weight: bold; 
    border-radius: 10px; 
    padding: 8px 14px; 
    display:inline-block;
}

/* ===== Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ===== */
input[type=number] { 
    width:75px; 
    text-align:center; 
    border-radius:5px; 
    border:1px solid #bbb; 
    padding:4px 6px;
}

/* ===== ØªØ¬Ø§ÙˆØ¨ ===== */
@media screen and (max-width: 800px) {
    table, thead, tbody, th, td, tr { display:block; }
    tr { margin-bottom:15px; }
    th { display:none; }
    td { text-align:right; border:none; border-bottom:1px solid #eee; position:relative; padding-left:50%; font-size:16px; }
    td:before { 
        content: attr(data-label); 
        position:absolute; 
        left:10px; 
        width:45%; 
        font-weight:bold; 
        text-align:left;
        font-size:16px;
    }
}
</style>
</head>
<body>

<h1>Ø§Ù„Ø¯ÙØ¹ - FAST NET</h1>
<button class="back-btn" onclick="window.location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
<select id="filterStatus">
    <option value="all">Ø§Ù„ÙƒÙ„</option>
    <option value="full">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</option>
    <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</option>
    <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
</select>

<table>
<thead>
<tr>
<th>#</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</th>
<th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
<th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
<th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
<th>Ø§Ù„Ø´Ù‡Ø±</th>
<th>Ø¯ÙØ¹</th>
<th>Ø·Ø¨Ø§Ø¹Ø©</th>
<th>ÙˆØ§ØªØ³Ø§Ø¨</th>
</tr>
</thead>
<tbody id="subscribersTable"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAolIz4UgOSbV1oe0XTl8a8pVfg7Pnfs1w",
  authDomain: "pos2026-310b7.firebaseapp.com",
  databaseURL: "https://pos2026-310b7-default-rtdb.firebaseio.com",
  projectId: "pos2026-310b7",
  storageBucket: "pos2026-310b7.appspot.com",
  messagingSenderId: "221592625111",
  appId: "1:221592625111:web:81b9704a1fa790bcd0f592"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const tableBody = document.getElementById("subscribersTable");
const searchInput = document.getElementById("search");
const filterStatus = document.getElementById("filterStatus");

let subscribers = [];

function renderTable(){
    const searchFilter = searchInput.value.toLowerCase();
    const statusFilterValue = filterStatus.value;
    tableBody.innerHTML = "";

    const currentMonth = new Date().getMonth() + 1;

    subscribers.forEach(sub => {
        const paid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0);
        const remaining = +(sub.price - paid).toFixed(2);
        const status = remaining===0 ? "full" : (remaining<sub.price ? "partial" : "unpaid");

        if(!(statusFilterValue==="all" || status===statusFilterValue)) return;

        const searchMatch = [sub.name, sub.phone, sub.address, sub.price].some(field =>
            field.toString().toLowerCase().includes(searchFilter)
        );
        if(!searchMatch) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td data-label="#">${sub.id}</td>
            <td data-label="Ø§Ù„Ø§Ø³Ù…">${sub.name}</td>
            <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${sub.phone}</td>
            <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">${sub.address}</td>
            <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ">$${sub.price}</td>
            <td data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹">$${paid.toFixed(2)}</td>
            <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ">$${remaining}</td>
            <td data-label="Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹" class="status-cell"></td>
            <td data-label="Ø§Ù„Ø´Ù‡Ø±">
                <select class="month-select">
                    ${[...Array(12)].map((_,i)=>`<option value="${i+1}" ${i+1===currentMonth ? "selected" : ""}>${i+1}</option>`).join("")}
                </select>
            </td>
            <td data-label="Ø¯ÙØ¹">
                <input type="number" class="pay-input" min="0.01" max="${remaining}" step="0.01" ${remaining===0?"disabled":""}>
                <button class="pay-btn" ${remaining===0?"disabled":""}>Ø¯ÙØ¹</button>
            </td>
            <td data-label="Ø·Ø¨Ø§Ø¹Ø©"><button class="print-btn">Ø·Ø¨Ø§Ø¹Ø©</button></td>
            <td data-label="ÙˆØ§ØªØ³Ø§Ø¨"><button class="wa-btn">ÙˆØ§ØªØ³Ø§Ø¨</button></td>
        `;

        const statusCell = tr.querySelector(".status-cell");
        statusCell.innerHTML = remaining===0 ? '<span class="status-paid">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</span>' :
                                remaining<sub.price ? '<span class="status-partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</span>' :
                                '<span class="status-unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>';

        const payBtn = tr.querySelector(".pay-btn");
        const payInput = tr.querySelector(".pay-input");
        const monthSelect = tr.querySelector(".month-select");

        payBtn.addEventListener("click", async ()=>{
            const amount = parseFloat(payInput.value);
            if(isNaN(amount) || amount<=0 || amount>remaining){
                return alert(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: $${remaining}`);
            }
            if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ Ù…Ø¨Ù„Øº $${amount} ØŸ`)) return;

            const month = monthSelect.value;
            const date = new Date().toLocaleDateString();

            const receiptRef = ref(db, "lastReceiptNumber");
            let lastReceiptSnap = await get(receiptRef);
            let lastReceipt = lastReceiptSnap.exists() ? lastReceiptSnap.val() : 6000;
            const receiptNumber = lastReceipt + 1;

            sub.payments.push({amount, month, date, receiptNumber});

            await update(ref(db, "subscribers/"+sub.fid), {payments: sub.payments});
            await set(receiptRef, receiptNumber);

            const newPaid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0).toFixed(2);
            const newRemaining = +(sub.price - newPaid).toFixed(2);
            tr.cells[5].innerText = `$${newPaid}`;
            tr.cells[6].innerText = `$${newRemaining}`;
            statusCell.innerHTML = newRemaining===0 ? '<span class="status-paid">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</span>' :
                                    newRemaining<sub.price ? '<span class="status-partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</span>' :
                                    '<span class="status-unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>';
            payInput.value = "";
            payInput.max = newRemaining;
            if(newRemaining===0){
                payInput.disabled = true;
                payBtn.disabled = true;
            }
            sendWhatsApp(sub, amount, month, receiptNumber);
        });

        const printBtn = tr.querySelector(".print-btn");
        printBtn.addEventListener("click", ()=>{
            if(sub.payments.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª");
            const last = sub.payments[sub.payments.length-1];
            const totalPaid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0);
            const remainingPrint = +(sub.price - totalPaid).toFixed(2);

            const win = window.open("", "", "width=200,height=800");
            win.document.write(`
                <div style="font-family:Arial, sans-serif; width:200px; padding:5px; direction:rtl; text-align:right; font-size:12px;">
                    <h3 style="text-align:center; margin:0;">FAST NET</h3>
                    <p style="text-align:center; margin:2px 0; font-size:12px;">71-338640   ğŸ“  71-346411</p>
                    <hr>
                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                        <tr><td>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</td><td>${last.receiptNumber || '-'}</td></tr>
                        <tr><td>Ø§Ù„Ø§Ø³Ù…:</td><td>${sub.name}</td></tr>
                        <tr><td>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</td><td>${sub.address}</td></tr>
                        <tr><td>Ø³Ø¹Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</td><td>$${sub.price}</td></tr>
                        <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</td><td>$${last.amount}</td></tr>
                        <tr><td>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</td><td>$${remainingPrint}</td></tr>
                        <tr><td>Ø§Ù„Ø´Ù‡Ø±:</td><td>${last.month}</td></tr>
                        <tr><td>Ø§Ù„ØªØ§Ø±ÙŠØ®:</td><td>${last.date}</td></tr>
                    </table>
                    <hr>
                </div>
            `);
            win.print();
        });

        const waBtn = tr.querySelector(".wa-btn");
        waBtn.addEventListener("click", ()=> sendWhatsApp(sub));

        tableBody.appendChild(tr);
    });

    if(tableBody.innerHTML==="") tableBody.innerHTML=`<tr><td colspan="12">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†.</td></tr>`;
}

function sendWhatsApp(sub, amount=null, month=null, receiptNumber=null){
    if(sub.payments.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª");
    const last = sub.payments[sub.payments.length-1];
    amount = amount ?? last.amount;
    month = month ?? last.month;
    receiptNumber = receiptNumber ?? last.receiptNumber;

    const totalPaid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0);
    const remaining = +(sub.price - totalPaid).toFixed(2);
    const date = last.date;
    let phone = sub.phone.startsWith("+") ? sub.phone : "+961"+sub.phone;

    const msg = `ğŸ“© Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ FAST NET
ğŸ§¾ Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„: ${receiptNumber}
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${sub.name}
ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${sub.address}
ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ :$${sub.price}
ğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹ : $${amount}
ğŸ’µ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: $${remaining}
ğŸ—“ï¸ Ø§Ù„Ø´Ù‡Ø±: ${month}
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}`;

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank");
}

onValue(ref(db,"subscribers"), snap=>{
    const data = snap.val() || {};
    subscribers = Object.entries(data).map(([fid, sub], i)=>({
        fid,
        id: i+1,
        name: sub.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
        phone: sub.phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
        address: sub.address || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
        price: Number(sub.price || 0),
        payments: Array.isArray(sub.payments) ? sub.payments : []
    }));
    renderTable();
});

searchInput.addEventListener("input", renderTable);
filterStatus.addEventListener("change", renderTable);
</script>
</body>
</html>
