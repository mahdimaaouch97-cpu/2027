<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¯ÙØ¹ - FAST NET</title>

<style>
body{
    font-family:Arial, sans-serif;
    padding:20px;
    direction:rtl;
    background:linear-gradient(135deg,#e8f0fe,#f9fafc);
}
h1{text-align:center;margin-bottom:20px}
#search,#filterStatus{
    padding:8px;width:100%;max-width:400px;
    display:block;margin:10px auto;
    border-radius:5px;border:1px solid #ccc
}
table{
    width:100%;border-collapse:collapse;margin-top:10px;
    background:white;box-shadow:0 2px 5px rgba(0,0,0,0.1)
}
th,td{padding:10px;border:1px solid #ddd;text-align:center}
th{background:#007bff;color:white}
button{
    padding:6px 10px;border:none;border-radius:4px;
    cursor:pointer;margin:2px
}
.pay-btn{background:#ffc107;color:white}
.print-btn{background:#28a745;color:white}
.wa-btn{background:#25d366;color:white}

.back-btn{
    background:#34495e;color:white;
    padding:18px 30px;font-size:20px;
    font-weight:bold;border-radius:6px;
    margin-bottom:15px;cursor:pointer
}

input[type=number]{width:70px;text-align:center}

.status-paid{background:#388e3c;color:white;padding:6px 10px;border-radius:8px}
.status-partial{background:#f57c00;color:white;padding:6px 10px;border-radius:8px}
.status-unpaid{background:#c62828;color:white;padding:6px 10px;border-radius:8px}
</style>
</head>

<body>

<h1>Ø§Ù„Ø¯ÙØ¹ - FAST NET</h1>
<button class="back-btn" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ">
<select id="filterStatus">
    <option value="all">Ø§Ù„ÙƒÙ„</option>
    <option value="full">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</option>
    <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</option>
    <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
</select>

<table>
<thead>
<tr>
<th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
<th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø¯ÙØ¹</th>
<th>Ø·Ø¨Ø§Ø¹Ø©</th><th>ÙˆØ§ØªØ³Ø§Ø¨</th>
</tr>
</thead>
<tbody id="subscribersTable"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAolIz4UgOSbV1oe0XTl8a8pVfg7Pnfs1w",
  authDomain: "pos2026-310b7.firebaseapp.com",
  databaseURL: "https://pos2026-310b7-default-rtdb.firebaseio.com",
  projectId: "pos2026-310b7",
  storageBucket: "pos2026-310b7.appspot.com",
  messagingSenderId: "221592625111",
  appId: "1:221592625111:web:81b9704a1fa790bcd0f592"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tableBody = document.getElementById("subscribersTable");
const searchInput = document.getElementById("search");
const filterStatus = document.getElementById("filterStatus");

let subscribers=[];

function renderTable(){
    tableBody.innerHTML="";
    const s=searchInput.value.toLowerCase();
    const f=filterStatus.value;

    subscribers.forEach(sub=>{
        const paid=sub.payments.reduce((a,p)=>a+Number(p.amount||0),0);
        const remaining=+(sub.price-paid).toFixed(2);
        const status=remaining===0?"full":remaining<sub.price?"partial":"unpaid";

        if(f!=="all" && f!==status) return;
        if(!sub.name.toLowerCase().includes(s) && !sub.phone.includes(s)) return;

        const tr=document.createElement("tr");
        tr.innerHTML=`
        <td>${sub.id}</td>
        <td>${sub.name}</td>
        <td>${sub.phone}</td>
        <td>${sub.address}</td>
        <td>$${sub.price}</td>
        <td>$${paid.toFixed(2)}</td>
        <td>$${remaining}</td>
        <td class="status-cell"></td>
        <td>
            <select class="month-select">
                ${[...Array(12)].map((_,i)=>`<option>${i+1}</option>`).join("")}
            </select>
        </td>
        <td>
            <input type="number" class="pay-input" min="0.01" max="${remaining}">
            <button class="pay-btn">Ø¯ÙØ¹</button>
        </td>
        <td><button class="print-btn">Ø·Ø¨Ø§Ø¹Ø©</button></td>
        <td><button class="wa-btn">ÙˆØ§ØªØ³Ø§Ø¨</button></td>
        `;

        const statusCell=tr.querySelector(".status-cell");
        statusCell.innerHTML=
            status==="full"?'<span class="status-paid">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</span>':
            status==="partial"?'<span class="status-partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</span>':
            '<span class="status-unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>';

        const payBtn=tr.querySelector(".pay-btn");
        const payInput=tr.querySelector(".pay-input");
        const monthSelect=tr.querySelector(".month-select");
        const printBtn=tr.querySelector(".print-btn");
        const waBtn=tr.querySelector(".wa-btn");

        payBtn.onclick=()=>{
            const amount=parseFloat(payInput.value);
            if(isNaN(amount)||amount<=0||amount>remaining){
                alert("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­"); return;
            }
            if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ $${amount} ØŸ`)) return;

            sub.payments.push({
                amount,
                month:monthSelect.value,
                date:new Date().toLocaleDateString()
            });

            update(ref(db,"subscribers/"+sub.fid),{
                payments:sub.payments
            }).then(renderTable);
        };

        printBtn.onclick=()=>{
            if(sub.payments.length===0){alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª");return;}
            const last=sub.payments[sub.payments.length-1];
            const win=window.open("","","width=220,height=400");
            win.document.write(`
            <div style="font-family:Arial;direction:rtl;font-size:12px">
            <h3 style="text-align:center">FAST NET</h3>
            <hr>
            Ø§Ù„Ø§Ø³Ù…: ${sub.name}<br>
            Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${sub.address}<br>
            Ø§Ù„Ø³Ø¹Ø±: $${sub.price}<br>
            Ø§Ù„Ù…Ø¯ÙÙˆØ¹: $${last.amount}<br>
            Ø§Ù„Ø´Ù‡Ø±: ${last.month}<br>
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${last.date}
            </div>`);
            win.print();
        };

        waBtn.onclick=()=>{
            if(sub.payments.length===0){alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª");return;}
            const last=sub.payments[sub.payments.length-1];
            const phone=sub.phone.startsWith("+")?sub.phone:"+961"+sub.phone;
            const msg=`ğŸ“© Ø¥Ø´Ø¹Ø§Ø± FAST NET
ğŸ‘¤ ${sub.name}
ğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹: $${last.amount}
ğŸ—“ï¸ Ø§Ù„Ø´Ù‡Ø±: ${last.month}
ğŸ“… ${last.date}`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");
        };

        tableBody.appendChild(tr);
    });

    if(!tableBody.innerHTML){
        tableBody.innerHTML=`<tr><td colspan="12">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
    }
}

onValue(ref(db,"subscribers"),snap=>{
    const data=snap.val()||{};
    subscribers=Object.entries(data).map(([fid,s],i)=>({
        fid,id:i+1,
        name:s.name||"",
        phone:s.phone||"",
        address:s.address||"",
        price:Number(s.price||0),
        payments:Array.isArray(s.payments)?s.payments:[]
    }));
    renderTable();
});

searchInput.oninput=renderTable;
filterStatus.onchange=renderTable;
</script>

</body>
</html>
