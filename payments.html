<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¯ÙØ¹ - FAST NET</title>
<style>
    .cancel-btn {
    background-color:#6c757d;
    color:white;
    padding:5px 10px;
    margin-top:4px;
    border-radius:4px;
    cursor:pointer;
}
.cancel-btn:hover {
    background-color:#5a6268;
}

body { 
    font-family: Arial, sans-serif; 
    padding:20px; 
    direction:rtl; 
    background: linear-gradient(135deg, #e8f0fe, #f9fafc);
}
h1 { 
    text-align:center; 
    margin-bottom:20px; 
}
#search, #filterStatus { 
    padding:8px; 
    width:100%; 
    max-width:400px; 
    display:block; 
    margin:10px auto; 
    border-radius:5px; 
    border:1px solid #ccc; 
}
table { 
    width:100%; 
    border-collapse:collapse; 
    margin-top:10px; 
    background:white; 
    box-shadow:0 2px 5px rgba(0,0,0,0.1); 
}
th, td { 
    padding:10px; 
    border:1px solid #ddd; 
    text-align:center; 
}
th { 
    background-color:#007bff; 
    color:white; 
}
button { 
    padding:5px 10px; 
    cursor:pointer; 
    margin:2px; 
    border-radius:4px; 
    border:none; 
}
.pay-btn { background-color:#ffc107; color:white; }
.print-btn { background-color:#28a745; color:white; }
.wa-btn { background-color:#25d366; color:white; }
/* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ø£ÙƒØ¨Ø± ÙˆÙˆØ§Ø¶Ø­ */
.back-btn { 
    background-color: #34495e; 
    color: white; 
    padding: 18px 30px; 
    margin-bottom:15px; 
    font-size: 20px; 
    font-weight: bold; 
    border-radius: 6px; 
    cursor: pointer; 
    border: none; 
    transition: background 0.3s; 
    display: inline-block;
    width: auto;
}
.back-btn:hover { background-color: #2c3e50; }
@media screen and (max-width: 600px) {
    .back-btn { width: 100%; text-align: center; }
}
input[type=number] { width:70px; text-align:center; border-radius:4px; border:1px solid #ccc; }
.status-paid { background-color: #388e3c; color: white; font-weight: bold; border-radius: 8px; padding: 8px 12px; }
.status-partial { background-color: #f57c00; color: white; font-weight: bold; border-radius: 8px; padding: 8px 12px; }
.status-unpaid { background-color: #c62828; color: white; font-weight: bold; border-radius: 8px; padding: 8px 12px; }
</style>
</head>
<body>

<h1>Ø§Ù„Ø¯ÙØ¹ - FAST NET</h1>
<button class="back-btn" onclick="window.location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
<select id="filterStatus">
    <option value="all">Ø§Ù„ÙƒÙ„</option>
    <option value="full">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</option>
    <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</option>
    <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
</select>

<table>
<thead>
<tr>
<th>#</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</th>
<th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
<th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
<th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
<th>Ø§Ù„Ø´Ù‡Ø±</th>
<th>Ø¯ÙØ¹</th>
<th>Ø·Ø¨Ø§Ø¹Ø©</th>
<th>ÙˆØ§ØªØ³Ø§Ø¨</th>
</tr>
</thead>
<tbody id="subscribersTable"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAolIz4UgOSbV1oe0XTl8a8pVfg7Pnfs1w",
  authDomain: "pos2026-310b7.firebaseapp.com",
  databaseURL: "https://pos2026-310b7-default-rtdb.firebaseio.com",
  projectId: "pos2026-310b7",
  storageBucket: "pos2026-310b7.appspot.com",
  messagingSenderId: "221592625111",
  appId: "1:221592625111:web:81b9704a1fa790bcd0f592"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const tableBody = document.getElementById("subscribersTable");
const searchInput = document.getElementById("search");
const filterStatus = document.getElementById("filterStatus");

let subscribers = [];

function renderTable(){
    const searchFilter = searchInput.value.toLowerCase();
    const statusFilterValue = filterStatus.value;
    tableBody.innerHTML = "";

    subscribers.forEach(sub => {
        const paid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0);
        const remaining = +(sub.price - paid).toFixed(2);
        const status = remaining===0 ? "full" : (remaining<sub.price ? "partial" : "unpaid");

        if(!(statusFilterValue==="all" || status===statusFilterValue)) return;
        if(!(sub.name.toLowerCase().includes(searchFilter) || sub.phone.includes(searchFilter))) return;
const cancelBtn = tr.querySelector(".cancel-btn");

cancelBtn.addEventListener("click", ()=>{
    if(sub.payments.length === 0){
        return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù„Ø¥Ù„ØºØ§Ø¦Ù‡Ø§");
    }

    const last = sub.payments[sub.payments.length - 1];

    if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø¢Ø®Ø± Ø¯ÙØ¹Ø© Ø¨Ù‚ÙŠÙ…Ø© $${last.amount} ØŸ`)) return;

    sub.payments.pop(); // Ø­Ø°Ù Ø¢Ø®Ø± Ø¯ÙØ¹Ø© ÙÙ‚Ø·

    update(ref(db, "subscribers/" + sub.fid), {
        payments: sub.payments
    }).then(()=>{
        renderTable();
    });
});

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${sub.id}</td>
            <td>${sub.name}</td>
            <td>${sub.phone}</td>
            <td>${sub.address}</td>
            <td>$${sub.price}</td>
            <td>$${paid.toFixed(2)}</td>
            <td>$${remaining}</td>
            <td class="status-cell"></td>
            <td><select class="month-select">${[...Array(12)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join("")}</select></td>
            <td>
                <td>
    <input type="number" class="pay-input" min="1" max="${remaining}" step="1" ${remaining===0?"disabled":""}>
    <button class="pay-btn" ${remaining===0?"disabled":""}>Ø¯ÙØ¹</button>
    <button class="cancel-btn">Ø¥Ù„ØºØ§Ø¡ Ø¢Ø®Ø± Ø¯ÙØ¹Ø©</button>
</td>

            <td><button class="print-btn">Ø·Ø¨Ø§Ø¹Ø©</button></td>
            <td><button class="wa-btn">ÙˆØ§ØªØ³Ø§Ø¨</button></td>
        `;

        const statusCell = tr.querySelector(".status-cell");
        statusCell.innerHTML = remaining===0 ? '<span class="status-paid">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</span>' :
                                remaining<sub.price ? '<span class="status-partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</span>' :
                                '<span class="status-unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>';

        const payBtn = tr.querySelector(".pay-btn");
        const payInput = tr.querySelector(".pay-input");
        const monthSelect = tr.querySelector(".month-select");

        payBtn.addEventListener("click", ()=>{
            const amount = parseFloat(payInput.value);
            if(isNaN(amount) || amount<=0 || amount>remaining){
                return alert(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: $${remaining}`);
            }
            const month = monthSelect.value;
            const date = new Date().toLocaleDateString();
            sub.payments.push({amount, month, date});
            update(ref(db, "subscribers/"+sub.fid), {payments: sub.payments}).then(()=>{
                const newPaid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0).toFixed(2);
                const newRemaining = +(sub.price - newPaid).toFixed(2);
                tr.cells[5].innerText = `$${newPaid}`;
                tr.cells[6].innerText = `$${newRemaining}`;
                statusCell.innerHTML = newRemaining===0 ? '<span class="status-paid">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</span>' :
                                        newRemaining<sub.price ? '<span class="status-partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</span>' :
                                        '<span class="status-unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>';
                payInput.value = "";
                payInput.max = newRemaining;
                if(newRemaining===0){
                    payInput.disabled = true;
                    payBtn.disabled = true;
                }
                sendWhatsApp(sub, amount, month);
            });
        });

        const printBtn = tr.querySelector(".print-btn");
        printBtn.addEventListener("click", ()=>{
            if(sub.payments.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª");
            const last = sub.payments[sub.payments.length-1];
            const totalPaid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0);
            const remainingPrint = +(sub.price - totalPaid).toFixed(2);

            const win = window.open("", "", "width=220,height=500");
            win.document.write(`
            <div style="font-family:Arial, sans-serif; width:200px; padding:5px; direction:rtl; text-align:right; font-size:12px;">
                <h3 style="text-align:center; margin:0;">FAST NET</h3>
                <p style="text-align:center; margin:2px 0; font-size:12px;">71-338640   ğŸ“  71-346411</p>
                <hr>
                <table style="width:100%; border-collapse:collapse; direction:rtl; text-align:right; font-size:12px;">
                    <tr><td>Ø§Ù„Ø§Ø³Ù…:</td><td>${sub.name}</td></tr>
                    <tr><td>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</td><td>${sub.address}</td></tr>
                    <tr><td>Ø³Ø¹Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</td><td>$${sub.price}</td></tr>
                    <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</td><td>$${last.amount}</td></tr>
                    <tr><td>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</td><td>$${remainingPrint}</td></tr>
                    <tr><td>Ø§Ù„Ø´Ù‡Ø±:</td><td>${last.month}</td></tr>
                    <tr><td>Ø§Ù„ØªØ§Ø±ÙŠØ®:</td><td>${last.date}</td></tr>
                </table>
                <hr>
                <p style="text-align:center; font-weight:bold;"></p>
            </div>
            `);
            win.print();
        });

        const waBtn = tr.querySelector(".wa-btn");
        waBtn.addEventListener("click", ()=> sendWhatsApp(sub));

        tableBody.appendChild(tr);
    });

    if(tableBody.innerHTML==="") tableBody.innerHTML=`<tr><td colspan="12">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†.</td></tr>`;
}

function sendWhatsApp(sub, amount=null, month=null){
    if(sub.payments.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª");
    const last = sub.payments[sub.payments.length-1];
    amount = amount ?? last.amount;
    month = month ?? last.month;
    const totalPaid = sub.payments.reduce((sum,p)=>sum+Number(p.amount||0),0);
    const remaining = +(sub.price - totalPaid).toFixed(2);
    const date = last.date;
    let phone = sub.phone.startsWith("+") ? sub.phone : "+961"+sub.phone;

    const msg = `ğŸ“© Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ FAST NET
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${sub.name}
ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${sub.address}
ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ :$${sub.price}
ğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹ : $${amount}
ğŸ’µ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: $${remaining}
ğŸ—“ï¸ Ø§Ù„Ø´Ù‡Ø±: ${month}
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}`;

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank");
}

onValue(ref(db,"subscribers"), snap=>{
    const data = snap.val() || {};
    subscribers = Object.entries(data).map(([fid, sub], i)=>({
        fid,
        id: i+1,
        name: sub.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
        phone: sub.phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
        address: sub.address || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
        price: Number(sub.price || 0),
        payments: Array.isArray(sub.payments) ? sub.payments : []
    }));
    renderTable();
});

searchInput.addEventListener("input", renderTable);
filterStatus.addEventListener("change", renderTable);
</script>
</body>
</html>
