<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة المشتركين - POSNEW</title>

<style>
/* ===== قاعدة الصفحة ===== */
body {
  font-family: Arial, sans-serif;
  padding:20px;
  background:#f0f2f5;
  direction:rtl;
  color:#333;
}
h1 {
  text-align:center;
  margin-bottom:20px;
  color:#222;
  text-shadow: 1px 1px 2px #ccc;
}

/* ===== شريط الأزرار العلوي ===== */
.top-buttons {
  text-align:center;
  margin-bottom:25px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
}
.top-buttons button {
  margin:5px;
  padding:12px 18px;
  font-weight:bold;
  border-radius:6px;
  border:none;
  cursor:pointer;
  transition: 0.3s;
  color:white;
}
.top-buttons .home-btn { background-color:#007bff; }
.top-buttons .payments-btn { background-color:#28a745; }
.top-buttons .import-btn { background-color:#17a2b8; }
.top-buttons .export-btn { background-color:#ffc107; color:#222; }
.top-buttons button:hover { opacity:0.85; }

/* ===== نموذج إضافة مشترك ===== */
.add-form {
  max-width:500px;
  margin:0 auto 20px;
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.add-form input {
  width:100%;
  padding:10px;
  margin-bottom:12px;
  border:1px solid #ccc;
  border-radius:6px;
}
.add-form button {
  width:100%;
  padding:12px;
  background:#007bff;
  color:white;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}
.add-form button:hover { opacity:0.85; }

/* ===== شريط البحث ===== */
.search-filter {
  max-width:450px;
  margin:0 auto 20px;
  display:flex;
  gap:10px;
}
.search-filter input, select {
  flex:1;
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
}

/* ===== الجدول ===== */
table {
  width:100%;
  border-collapse:collapse;
  background:white;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
th, td {
  padding:12px;
  border:1px solid #ddd;
  text-align:center;
  font-size:20px;
}
th {
  background:#007bff;
  color:white;
}
.delete-btn { background:#dc3545; color:white; padding:6px 10px; border:none; cursor:pointer; border-radius:4px; }
.reminder-btn { background:#25D366; color:white; padding:6px 10px; border:none; cursor:pointer; border-radius:4px; }
.status-full { background:#388e3c; color:white; padding:5px 8px; border-radius:4px; }
.status-partial { background:#f57c00; color:white; padding:5px 8px; border-radius:4px; }
.status-unpaid { background:#c62828; color:white; padding:5px 8px; border-radius:4px; }
.editing-row { background-color: #fff3b0 !important; }
.edit-btn, .save-btn, .cancel-btn { padding:5px 8px; border:none; border-radius:4px; cursor:pointer; font-size:0.85em; }
.edit-btn { background:#007bff; color:white; }
.save-btn { background:#28a745; color:white; }
.cancel-btn { background:#ffc107; color:#222; }

/* ===== تجاوب الهاتف ===== */
@media(max-width:768px){
  .top-buttons { flex-direction:column; gap:8px; }
  .search-filter { flex-direction:column; gap:8px; }
  .add-form { width:95%; padding:15px; }
  th, td { font-size:0.85em; padding:8px; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>

<h1>إدارة المشتركين</h1>

<div class="top-buttons">
  <button class="home-btn" onclick="location.href='index.html'">الرئيسية</button>
  <button class="payments-btn" onclick="location.href='payments.html'">الدفع</button>
  <input type="file" id="importFile" style="display:none" accept=".xlsx,.xls">
  <button class="import-btn" onclick="document.getElementById('importFile').click()">استيراد من Excel</button>
  <button class="export-btn" onclick="exportToExcel()">تصدير إلى Excel</button>
</div>

<div class="add-form">
  <input id="name" placeholder="اسم المشترك">
  <input id="phone" placeholder="رقم الهاتف">
  <input id="address" placeholder="العنوان">
  <input id="price" type="number" placeholder="سعر الاشتراك">
  <button id="addBtn">إضافة مشترك</button>
</div>

<div class="search-filter">
  <input id="search" placeholder="بحث..." onkeyup="renderTable()">
  <select id="filterStatus" onchange="renderTable()">
    <option value="all">الكل</option>
    <option value="full">مدفوع كليًا</option>
    <option value="partial">مدفوع جزئيًا</option>
    <option value="unpaid">غير مدفوع</option>
  </select>
</div>

<table>
<thead>
<tr>
<th>#</th><th>الاسم</th><th>الهاتف</th><th>العنوان</th>
<th>السعر</th><th>المدفوع</th><th>المتبقي</th>
<th>الحالة</th><th>واتساب</th><th>الإجراءات</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAolIz4UgOSbV1oe0XTl8a8pVfg7Pnfs1w",
  authDomain: "pos2026-310b7.firebaseapp.com",
  databaseURL: "https://pos2026-310b7-default-rtdb.firebaseio.com",
  projectId: "pos2026-310b7",
  storageBucket: "pos2026-310b7.appspot.com",
  messagingSenderId: "221592625111",
  appId: "1:221592625111:web:81b9704a1fa790bcd0f592"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* عناصر DOM */
const nameInput = document.getElementById("name");
const phoneInput = document.getElementById("phone");
const addressInput = document.getElementById("address");
const priceInput = document.getElementById("price");
const addBtn = document.getElementById("addBtn");
const tableBody = document.getElementById("tableBody");
const search = document.getElementById("search");
const filterStatus = document.getElementById("filterStatus");

let subscribers = [];

/* تحميل البيانات */
onValue(ref(db,"subscribers"), snap => {
  const data = snap.val() || {};
  subscribers = Object.entries(data).map(([id,sub],i)=>({
    fid:id,
    id:i+1,
    name: sub.name || "",
    phone: sub.phone || "",
    address: sub.address || "",
    price: Number(sub.price||0),
    payments: sub.payments || []
  }));
  renderTable();
});

/* عرض الجدول */
window.renderTable = function(){
  const s = search.value.toLowerCase();
  const f = filterStatus.value;
  tableBody.innerHTML="";
  subscribers.filter(sub=>{
    const paid = (sub.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
    const rem = sub.price - paid;
    let st="unpaid"; if(rem==0) st="full"; else if(rem<sub.price) st="partial";
    return (f=="all"||f==st) && (sub.name.toLowerCase().includes(s)||sub.phone.includes(s));
  }).forEach(sub=>{
    const paid = (sub.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
    const rem = sub.price - paid;
    let txt="غير مدفوع",cls="status-unpaid";
    if(rem===0){txt="مدفوع كليًا";cls="status-full";}
    else if(rem<sub.price){txt="جزئي";cls="status-partial";}

    tableBody.innerHTML+=`
<tr data-id="${sub.fid}">
<td>${sub.id}</td>
<td class="field name">${sub.name}</td>
<td class="field phone">${sub.phone}</td>
<td class="field address">${sub.address}</td>
<td class="field price">${sub.price}</td>
<td>$${paid}</td>
<td>$${rem}</td>
<td class="${cls}">${txt}</td>
<td>${rem>0?`<button class="reminder-btn" onclick="sendWA('${sub.fid}')">واتساب</button>`:"✔"}</td>
<td>
  <button class="edit-btn" onclick="startEdit(this)">تعديل</button>
  <button class="delete-btn" onclick="del('${sub.fid}')">حذف</button>
</td>
</tr>`;
  });
}

/* إضافة مشترك */
addBtn.onclick = () => {
  if(!nameInput.value || !phoneInput.value || !priceInput.value) return alert("بيانات ناقصة");
  push(ref(db,"subscribers"),{
    name: nameInput.value,
    phone: phoneInput.value,
    address: addressInput.value,
    price: Number(priceInput.value),
    payments:[]
  });
  nameInput.value = phoneInput.value = addressInput.value = priceInput.value = "";
}

/* تعديل المشترك */
window.startEdit = (btn) => {
  const row = btn.parentElement.parentElement;
  if(row.classList.contains("editing-row")) return;
  row.classList.add("editing-row");
  const fields = ["name","phone","address","price"];
  const originalData = {};
  fields.forEach(f=>{
    const cell = row.querySelector(`.field.${f}`);
    originalData[f] = cell.textContent;
    const input = document.createElement("input");
    input.value = cell.textContent;
    if(f==="price") input.type="number";
    cell.textContent = "";
    cell.appendChild(input);
  });
  row.querySelector("td:last-child").innerHTML = `
    <button class="save-btn" onclick="saveEdit(this)">حفظ</button>
    <button class="cancel-btn" onclick='cancelEdit(this,${JSON.stringify(originalData)})'>إلغاء</button>
  `;
}

window.saveEdit = (btn) => {
  const row = btn.parentElement.parentElement;
  const fid = row.dataset.id;
  const updateData = {};
  ["name","phone","address","price"].forEach(f=>{
    const input = row.querySelector(`.field.${f} input`);
    updateData[f] = (f==="price")? Number(input.value): input.value;
  });
  update(ref(db,"subscribers/"+fid), updateData).then(()=>{
    row.classList.remove("editing-row");
    renderTable();
  });
}

window.cancelEdit = (btn,originalData) => {
  const row = btn.parentElement.parentElement;
  ["name","phone","address","price"].forEach(f=>{
    const cell = row.querySelector(`.field.${f}`);
    cell.textContent = originalData[f];
  });
  row.classList.remove("editing-row");
  row.querySelector("td:last-child").innerHTML = `
    <button class="edit-btn" onclick="startEdit(this)">تعديل</button>
    <button class="delete-btn" onclick="del('${row.dataset.id}')">حذف</button>
  `;
}

/* حذف */
window.del = id => confirm("تأكيد الحذف؟") && remove(ref(db,"subscribers/"+id));

/* واتساب */
window.sendWA = id => {
  const s = subscribers.find(x => x.fid == id);
  if(!s.phone.startsWith("+")) s.phone = "+961" + s.phone;
  const paid = (s.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
  const rem = s.price - paid;
  let msg = `السيد/ة ${s.name} المحترم/ة،\n`;
  if(rem === 0){ alert(`${s.name} دفع كامل المبلغ بالفعل!`); return; }
  else if(rem < s.price){
    msg += `نذكركم بدفع إشتراك الأنترنت.\nقيمة الإشتراك: $${s.price}\nالمبلغ المدفوع جزئيًا: $${paid}\nالمتبقي: $${rem}\nيرجى دفع المبلغ المتبقي في أقرب وقت ممكن.`;
  } else {
    msg += `نذكركم بدفع إشتراك الأنترنت.\nقيمة الإشتراك: $${s.price}\nلم يتم دفع أي مبلغ بعد.\nيرجى دفع الاشتراك في أقرب وقت ممكن.`;
  }
  window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(msg)}`);
}

/* استيراد Excel */
document.getElementById('importFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    json.forEach(row=>{
      const name = row["الاسم"];
      const phone = row["الهاتف"];
      const address = row["العنوان"] || "";
      const price = row["السعر"];
      if(name && phone && price){
        push(ref(db,"subscribers"),{ name, phone:phone.toString(), address, price:Number(price), payments:[] });
      }
    });
    alert("تم استيراد البيانات بنجاح!");
    e.target.value="";
  };
  reader.readAsArrayBuffer(file);
});

/* تصدير Excel */
window.exportToExcel = function() {
  const dbRef = ref(db,"subscribers");
  onValue(dbRef, snap=>{
    const dataFirebase = snap.val();
    if(!dataFirebase){alert("لا يوجد مشتركين للتصدير!"); return;}
    const list = Object.entries(dataFirebase).map(([id,sub],i)=>{
      const payments = sub.payments || [];
      const paid = payments.reduce((a,p)=>a+Number(p.amount||0),0);
      const rem = sub.price - paid;
      let status="غير مدفوع";
      if(rem===0) status="مدفوع كليًا"; else if(rem<sub.price) status="جزئي";
      return {"#":i+1,"الاسم":sub.name,"الهاتف":sub.phone,"العنوان":sub.address,"السعر":sub.price,"المدفوع":paid,"المتبقي":rem,"الحالة":status};
    });
    const ws = XLSX.utils.json_to_sheet(list);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "المشتركين");
    XLSX.writeFile(wb, "subscribers.xlsx");
  }, { onlyOnce:true });
}
</script>
</body>
</html>



