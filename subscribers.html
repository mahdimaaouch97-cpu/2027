<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة المشتركين - POSNEW</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f5f5f5; direction:rtl; }
h1 { text-align:center; margin-bottom:15px; color:#333; }
.top-buttons { text-align:center; margin-bottom:20px; }
.top-buttons button { margin:5px; padding:10px 16px; font-weight:bold; border-radius:5px; border:none; cursor:pointer; }
.home-btn { background-color:#007bff; color:white; }
.search-filter { max-width:400px; margin:0 auto 15px; display:flex; gap:10px; }
.search-filter input, select { flex:1; padding:8px; }
table { width:100%; border-collapse:collapse; background:white; }
th, td { padding:10px; border:1px solid #ddd; text-align:center; }
th { background:#007bff; color:white; }
.delete-btn { background:#dc3545; color:white; padding:5px 8px; border:none; cursor:pointer; border-radius:3px; }
.reminder-btn { background:#25D366; color:white; padding:5px 8px; border:none; cursor:pointer; border-radius:3px; }
.status-full { background:#388e3c; color:white; }
.status-partial { background:#f57c00; color:white; }
.status-unpaid { background:#c62828; color:white; }
.editable-cell { cursor:pointer; }
.editable-cell input { width:90%; padding:2px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>

<h1>إدارة المشتركين</h1>

<div class="top-buttons">
  <button class="home-btn" onclick="location.href='index.html'">الرئيسية</button>
  <button class="home-btn" onclick="location.href='payments.html'">الدفع</button>
  <input type="file" id="importFile" style="display:none" accept=".xlsx,.xls">
  <button class="home-btn" onclick="document.getElementById('importFile').click()">استيراد من Excel</button>
  <button class="home-btn" onclick="exportToExcel()">تصدير إلى Excel</button>
</div>

<div class="search-filter">
  <input id="search" placeholder="بحث..." onkeyup="renderTable()">
  <select id="filterStatus" onchange="renderTable()">
    <option value="all">الكل</option>
    <option value="full">مدفوع كليًا</option>
    <option value="partial">مدفوع جزئيًا</option>
    <option value="unpaid">غير مدفوع</option>
  </select>
</div>

<table>
<thead>
<tr>
<th>#</th><th>الاسم</th><th>الهاتف</th><th>العنوان</th>
<th>السعر</th><th>المدفوع</th><th>المتبقي</th>
<th>الحالة</th><th>واتساب</th><th>حذف</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAolIz4UgOSbV1oe0XTl8a8pVfg7Pnfs1w",
  authDomain: "pos2026-310b7.firebaseapp.com",
  databaseURL: "https://pos2026-310b7-default-rtdb.firebaseio.com",
  projectId: "pos2026-310b7",
  storageBucket: "pos2026-310b7.appspot.com",
  messagingSenderId: "221592625111",
  appId: "1:221592625111:web:81b9704a1fa790bcd0f592"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tableBody = document.getElementById("tableBody");
const search = document.getElementById("search");
const filterStatus = document.getElementById("filterStatus");

let subscribers = [];

/* تحميل البيانات */
onValue(ref(db,"subscribers"), snap => {
  const data = snap.val() || {};
  subscribers = Object.entries(data).map(([id,sub],i)=>({
    fid:id,
    id:i+1,
    name: sub.name || "",
    phone: sub.phone || "",
    address: sub.address || "",
    price: Number(sub.price||0),
    payments: sub.payments || []
  }));
  renderTable();
});

/* عرض الجدول مع التعديل المباشر */
window.renderTable = function(){
  const s = search.value.toLowerCase();
  const f = filterStatus.value;
  tableBody.innerHTML="";
  subscribers.filter(sub=>{
    const paid = (sub.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
    const rem = sub.price - paid;
    let st="unpaid"; if(rem==0) st="full"; else if(rem<sub.price) st="partial";
    return (f=="all"||f==st) && (sub.name.toLowerCase().includes(s)||sub.phone.includes(s));
  }).forEach(sub=>{
    const paid = (sub.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
    const rem = sub.price - paid;
    let txt="غير مدفوع",cls="status-unpaid";
    if(rem==0){txt="مدفوع كليًا";cls="status-full";}
    else if(rem<sub.price){txt="جزئي";cls="status-partial";}

    tableBody.innerHTML+=`
<tr data-id="${sub.fid}">
<td>${sub.id}</td>
<td class="editable-cell" data-field="name">${sub.name}</td>
<td class="editable-cell" data-field="phone">${sub.phone}</td>
<td class="editable-cell" data-field="address">${sub.address}</td>
<td class="editable-cell" data-field="price">${sub.price}</td>
<td>$${paid}</td>
<td>$${rem}</td>
<td class="${cls}">${txt}</td>
<td>${rem>0?`<button class="reminder-btn" onclick="sendWA('${sub.fid}')">واتساب</button>`:"✔"}</td>
<td><button class="delete-btn" onclick="del('${sub.fid}')">حذف</button></td>
</tr>`;
  });

  // تفعيل التعديل عند الضغط على أي خلية
  document.querySelectorAll(".editable-cell").forEach(cell=>{
    cell.onclick = function(){
      const currentVal = this.textContent;
      const input = document.createElement("input");
      input.value = currentVal;
      this.textContent = "";
      this.appendChild(input);
      input.focus();

      input.onblur = () => {
        const newVal = input.value;
        const field = cell.dataset.field;
        const fid = cell.parentElement.dataset.id;

        const updateData = {};
        updateData[field] = (field==="price") ? Number(newVal) : newVal;

        update(ref(db,"subscribers/"+fid), updateData);
        cell.textContent = newVal;
      }
    }
  });
}

/* حذف */
window.del = id => confirm("تأكيد الحذف؟") && remove(ref(db,"subscribers/"+id));

/* واتساب */
window.sendWA = id => {
  const s = subscribers.find(x => x.fid == id);
  if(!s.phone.startsWith("+")) s.phone = "+961" + s.phone;

  const paid = (s.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
  const rem = s.price - paid;

  let msg = `السيد/ة ${s.name} المحترم/ة،\n`;
  if(rem === 0){
      alert(`${s.name} دفع كامل المبلغ بالفعل!`);
      return;
  } else if(rem < s.price){
      msg += `نذكركم بدفع إشتراك الأنترنت.\n`;
      msg += `قيمة الإشتراك: $${s.price}\n`;
      msg += `المبلغ المدفوع جزئيًا: $${paid}\n`;
      msg += `المتبقي: $${rem}\n`;
      msg += `يرجى دفع المبلغ المتبقي في أقرب وقت ممكن.`;
  } else{
      msg += `نذكركم بدفع إشتراك الأنترنت.\n`;
      msg += `قيمة الإشتراك: $${s.price}\n`;
      msg += `لم يتم دفع أي مبلغ بعد.\n`;
      msg += `يرجى دفع الاشتراك في أقرب وقت ممكن.`;
  }

  window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(msg)}`);
}

/* استيراد Excel */
document.getElementById('importFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(evt){
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    json.forEach(row=>{
      const name = row["الاسم"];
      const phone = row["الهاتف"];
      const address = row["العنوان"] || "";
      const price = row["السعر"];
      if(name && phone && price){
        push(ref(db,"subscribers"),{
          name:name,
          phone:phone.toString(),
          address:address,
          price:Number(price),
          payments:[]
        });
      }
    });

    alert("تم استيراد البيانات بنجاح!");
    e.target.value="";
  };
  reader.readAsArrayBuffer(file);
});

/* تصدير Excel */
window.exportToExcel = function() {
  const dbRef = ref(db,"subscribers");
  onValue(dbRef, snap=>{
    const dataFirebase = snap.val();
    if(!dataFirebase){alert("لا يوجد مشتركين للتصدير!"); return;}
    const list = Object.entries(dataFirebase).map(([id,sub],i)=>{
      const payments = sub.payments || [];
      const paid = payments.reduce((a,p)=>a+Number(p.amount||0),0);
      const rem = sub.price - paid;
      let status="غير مدفوع";
      if(rem===0) status="مدفوع كليًا"; else if(rem<sub.price) status="جزئي";
      return {
        "#":i+1,"الاسم":sub.name,"الهاتف":sub.phone,"العنوان":sub.address,
        "السعر":sub.price,"المدفوع":paid,"المتبقي":rem,"الحالة":status
      };
    });
    const ws = XLSX.utils.json_to_sheet(list);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "المشتركين");
    XLSX.writeFile(wb, "subscribers.xlsx");
  }, { onlyOnce:true });
}
</script>
</body>
</html>
