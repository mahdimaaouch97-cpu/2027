<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† - POSNEW</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f5f5f5; direction:rtl; }
h1 { text-align:center; margin-bottom:15px; color:#333; }
.top-buttons { text-align:center; margin-bottom:20px; }
.top-buttons button { margin:5px; padding:10px 16px; font-weight:bold; border-radius:5px; border:none; cursor:pointer; }
.home-btn { background-color:#007bff; color:white; }
.search-filter { max-width:400px; margin:0 auto 15px; display:flex; gap:10px; }
.search-filter input, select { flex:1; padding:8px; }
.add-form { max-width:500px; margin:0 auto 15px; background:#fff; padding:15px; border-radius:8px; }
.add-form input { width:100%; padding:8px; margin-bottom:10px; }
.add-form button { width:100%; padding:10px; background:#007bff; color:white; border:none; cursor:pointer; }
table { width:100%; border-collapse:collapse; background:white; }
th, td { padding:10px; border:1px solid #ddd; text-align:center; }
th { background:#007bff; color:white; }
.delete-btn { background:#dc3545; color:white; padding:5px 8px; border:none; cursor:pointer; }
.reminder-btn { background:#25D366; color:white; padding:5px 8px; border:none; cursor:pointer; }
.status-full { background:#388e3c; color:white; }
.status-partial { background:#f57c00; color:white; }
.status-unpaid { background:#c62828; color:white; }
a.name-link { cursor:pointer; color:#007bff; text-decoration:underline; }
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>

<h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h1>

<div class="top-buttons">
  <button class="home-btn" onclick="location.href='index.html'">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button class="home-btn" onclick="location.href='payments.html'">Ø§Ù„Ø¯ÙØ¹</button>
  <input type="file" id="importFile" style="display:none" accept=".xlsx,.xls">
  <button class="home-btn" onclick="document.getElementById('importFile').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</button>
  <button class="home-btn" onclick="exportToExcel()">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
</div>

<div class="search-filter">
  <input id="search" placeholder="Ø¨Ø­Ø«..." onkeyup="renderTable()">
  <select id="filterStatus" onchange="renderTable()">
    <option value="all">Ø§Ù„ÙƒÙ„</option>
    <option value="full">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</option>
    <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</option>
    <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
  </select>
</div>

<div class="add-form">
  <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ">
  <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
  <input id="price" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">
  <button id="addBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ</button>
</div>

<table>
<thead>
<tr>
<th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
<th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ÙˆØ§ØªØ³Ø§Ø¨</th><th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ğŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAolIz4UgOSbV1oe0XTl8a8pVfg7Pnfs1w",
  authDomain: "pos2026-310b7.firebaseapp.com",
  databaseURL: "https://pos2026-310b7-default-rtdb.firebaseio.com",
  projectId: "pos2026-310b7",
  storageBucket: "pos2026-310b7.appspot.com",
  messagingSenderId: "221592625111",
  appId: "1:221592625111:web:81b9704a1fa790bcd0f592"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const nameInput = document.getElementById("name");
const phoneInput = document.getElementById("phone");
const addressInput = document.getElementById("address");
const priceInput = document.getElementById("price");
const addBtn = document.getElementById("addBtn");
const tableBody = document.getElementById("tableBody");
const search = document.getElementById("search");
const filterStatus = document.getElementById("filterStatus");

let subscribers = [];
let editId = null;

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
onValue(ref(db,"subscribers"), snap => {
  const data = snap.val() || {};
  subscribers = Object.entries(data).map(([id,sub],i)=>({
    fid:id,
    id:i+1,
    name: sub.name || "",
    phone: sub.phone || "",
    address: sub.address || "",
    price: Number(sub.price||0),
    payments: sub.payments || []
  }));
  renderTable();
});

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
window.renderTable = function(){
  const s = search.value.toLowerCase();
  const f = filterStatus.value;
  tableBody.innerHTML="";
  subscribers.filter(sub=>{
    const paid = (sub.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
    const rem = sub.price - paid;
    let st="unpaid"; if(rem==0) st="full"; else if(rem<sub.price) st="partial";
    return (f=="all"||f==st) && (sub.name.toLowerCase().includes(s)||sub.phone.includes(s));
  }).forEach(sub=>{
    const paid = (sub.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
    const rem = sub.price - paid;
    let txt="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",cls="status-unpaid";
    if(rem==0){txt="Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§";cls="status-full";}
    else if(rem<sub.price){txt="Ø¬Ø²Ø¦ÙŠ";cls="status-partial";}

    tableBody.innerHTML+=`
<tr>
<td>${sub.id}</td>
<td><a class="name-link" onclick="editSub('${sub.fid}')">${sub.name}</a></td>
<td>${sub.phone}</td>
<td>${sub.address}</td>
<td>$${sub.price}</td>
<td>$${paid}</td>
<td>$${rem}</td>
<td class="${cls}">${txt}</td>
<td>${rem>0?`<button class="reminder-btn" onclick="sendWA('${sub.fid}')">ÙˆØ§ØªØ³Ø§Ø¨</button>`:"âœ”"}</td>
<td><button class="delete-btn" onclick="del('${sub.fid}')">Ø­Ø°Ù</button></td>
</tr>`;
  });
}

/* Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ */
addBtn.onclick = () => {
  if(!nameInput.value || !phoneInput.value || !priceInput.value) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

  if(editId){
    const oldPayments = subscribers.find(s=>s.fid===editId).payments || [];
    update(ref(db,"subscribers/"+editId),{
      name:nameInput.value,
      phone:phoneInput.value,
      address:addressInput.value,
      price:Number(priceInput.value),
      payments: oldPayments
    });
    editId=null;
    addBtn.textContent="Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ";
  }else{
    push(ref(db,"subscribers"),{
      name:nameInput.value,
      phone:phoneInput.value,
      address:addressInput.value,
      price:Number(priceInput.value),
      payments:[]
    });
  }

  nameInput.value=phoneInput.value=addressInput.value=priceInput.value="";
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… */
window.editSub = id =>{
  const s = subscribers.find(x=>x.fid===id);
  if(!s) return;
  nameInput.value=s.name;
  phoneInput.value=s.phone;
  addressInput.value=s.address;
  priceInput.value=s.price;
  editId=id;
  addBtn.textContent="ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
  window.scrollTo({top:0,behavior:"smooth"});
}

/* Ø­Ø°Ù */
window.del = id => confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ") && remove(ref(db,"subscribers/"+id));

/* ÙˆØ§ØªØ³Ø§Ø¨ */
window.sendWA = id => {
  const s = subscribers.find(x => x.fid == id);
  if(!s.phone.startsWith("+")) s.phone = "+961" + s.phone;

  const paid = (s.payments || []).reduce((a,p)=>a+Number(p.amount||0),0);
  const rem = s.price - paid;

  let msg = `Ø§Ù„Ø³ÙŠØ¯/Ø© ${s.name} Ø§Ù„Ù…Ø­ØªØ±Ù…/Ø©ØŒ\n`;
  if(rem === 0){
      alert(`${s.name} Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„ÙØ¹Ù„!`);
      return;
  } else if(rem < s.price){
      msg += `Ù†Ø°ÙƒØ±ÙƒÙ… Ø¨Ø¯ÙØ¹ Ø¥Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£Ù†ØªØ±Ù†Øª.\n`;
      msg += `Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ: $${s.price}\n`;
      msg += `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§: $${paid}\n`;
      msg += `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: $${rem}\n`;
      msg += `ÙŠØ±Ø¬Ù‰ Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.`;
  } else{
      msg += `Ù†Ø°ÙƒØ±ÙƒÙ… Ø¨Ø¯ÙØ¹ Ø¥Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£Ù†ØªØ±Ù†Øª.\n`;
      msg += `Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ: $${s.price}\n`;
      msg += `Ù„Ù… ÙŠØªÙ… Ø¯ÙØ¹ Ø£ÙŠ Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯.\n`;
      msg += `ÙŠØ±Ø¬Ù‰ Ø¯ÙØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.`;
  }

  window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(msg)}`);
}

/* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel */
document.getElementById('importFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(evt){
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    json.forEach(row=>{
      const name = row["Ø§Ù„Ø§Ø³Ù…"];
      const phone = row["Ø§Ù„Ù‡Ø§ØªÙ"];
      const address = row["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || "";
      const price = row["Ø§Ù„Ø³Ø¹Ø±"];
      if(name && phone && price){
        push(ref(db,"subscribers"),{
          name:name,
          phone:phone.toString(),
          address:address,
          price:Number(price),
          payments:[]
        });
      }
    });

    alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
    e.target.value="";
  };
  reader.readAsArrayBuffer(file);
});

/* ØªØµØ¯ÙŠØ± Excel */
window.exportToExcel = function() {
  const dbRef = ref(db,"subscribers");
  onValue(dbRef, snap=>{
    const dataFirebase = snap.val();
    if(!dataFirebase){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØµØ¯ÙŠØ±!"); return;}
    const list = Object.entries(dataFirebase).map(([id,sub],i)=>{
      const payments = sub.payments || [];
      const paid = payments.reduce((a,p)=>a+Number(p.amount||0),0);
      const rem = sub.price - paid;
      let status="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹";
      if(rem===0) status="Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§"; else if(rem<sub.price) status="Ø¬Ø²Ø¦ÙŠ";
      return {
        "#":i+1,"Ø§Ù„Ø§Ø³Ù…":sub.name,"Ø§Ù„Ù‡Ø§ØªÙ":sub.phone,"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†":sub.address,
        "Ø§Ù„Ø³Ø¹Ø±":sub.price,"Ø§Ù„Ù…Ø¯ÙÙˆØ¹":paid,"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ":rem,"Ø§Ù„Ø­Ø§Ù„Ø©":status
      };
    });
    const ws = XLSX.utils.json_to_sheet(list);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†");
    XLSX.writeFile(wb, "subscribers.xlsx");
  }, { onlyOnce:true });
}
</script>
</body>
</html>
