<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª - FAST NET</title>
<style>
body { font-family: Arial; background: #f5f5f5; direction: rtl; margin:0; padding:20px;}
.container { max-width:1000px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
h1 { text-align:center; margin-bottom:20px; font-size:24px;}
.controls { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:15px;}
.controls input, .controls select { padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:5px; margin:5px 0; flex:1; min-width:150px;}
table { width:100%; border-collapse:collapse; font-size:13px;}
th, td { border:1px solid #ddd; padding:8px; text-align:right; vertical-align:middle;}
th { background:#007bff; color:#fff;}
.status-label { padding:3px 7px; border-radius:4px; color:#fff; font-size:12px; display:inline-block;}
.status-full { background:#28a745; }
.status-partial { background:#ffc107; color:#000; }
.status-none { background:#dc3545; }
.print-btn { padding:5px 10px; font-size:12px; cursor:pointer; border:none; background:#007bff; color:#fff; border-radius:4px;}
.print-btn:hover { background:#0056b3;}
.back-btn { padding:15px 25px; font-size:18px; margin-bottom:20px; border:none; border-radius:8px; background:#007bff; color:#fff; cursor:pointer;}
.back-btn:hover { background:#0056b3;}
</style>
</head>
<body>

<div class="container">
<button class="back-btn" onclick="window.location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
<h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</h1>

<div class="controls">
    <input type="text" id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...">
    <select id="filterStatus">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="full">Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§</option>
        <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§</option>
    </select>
</div>

<table>
<thead>
<tr>
<th>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
<th>Ø§Ù„Ù…Ø´ØªØ±Ùƒ</th>
<th>Ø§Ù„Ø³Ø¹Ø±</th>
<th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
<th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
<th>Ø§Ù„Ø´Ù‡Ø±</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
<th>Ø·Ø¨Ø§Ø¹Ø©</th>
</tr>
</thead>
<tbody id="receiptsTableBody"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ğŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAolIz4UgOSbV1oe0XTl8a8pVfg7Pnfs1w",
  authDomain: "pos2026-310b7.firebaseapp.com",
  databaseURL: "https://pos2026-310b7-default-rtdb.firebaseio.com",
  projectId: "pos2026-310b7",
  storageBucket: "pos2026-310b7.appspot.com",
  messagingSenderId: "221592625111",
  appId: "1:221592625111:web:81b9704a1fa790bcd0f592"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tableBody = document.getElementById("receiptsTableBody");
const searchInput = document.getElementById("search");
const filterSelect = document.getElementById("filterStatus");

let subscribers = [];
let receipts = [];
let lastReceiptNumber = 5000; // Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† 5001

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù…Ù† Firebase
onValue(ref(db, "subscribers"), snap => {
    const data = snap.val() || {};
    subscribers = Object.entries(data).map(([fid, sub], i) => ({
        fid,
        id: i+1,
        name: sub.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
        phone: sub.phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
        address: sub.address || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
        price: Number(sub.price || 0),
        payments: Array.isArray(sub.payments) ? sub.payments : []
    }));

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª Ù„ÙƒÙ„ Ø¯ÙØ¹Ø©
    receipts = [];
    subscribers.forEach(sub => {
        sub.payments.forEach(p => {
            lastReceiptNumber++;
            const totalPaid = sub.payments.slice(0, sub.payments.indexOf(p)+1)
                                 .reduce((a,b)=>a+b.amount,0);
            const remaining = +(sub.price - totalPaid).toFixed(2);
            receipts.push({
                id: lastReceiptNumber,
                subscriberId: sub.id,
                name: sub.name,
                address: sub.address,
                total: sub.price,
                amount: p.amount,
                remaining: remaining,
                month: p.month,
                date: p.date
            });
        });
    });

    renderTable();
});

// Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function renderTable() {
    const search = searchInput.value.toLowerCase();
    const filter = filterSelect.value;
    tableBody.innerHTML = "";

    let filtered = receipts.filter(r=>{
        const matchSearch = r.name.toLowerCase().includes(search);
        let matchFilter = true;
        if(filter==="full") matchFilter = r.remaining===0;
        if(filter==="partial") matchFilter = r.remaining>0 && r.remaining<r.total;
        return matchSearch && matchFilter;
    });

    if(filtered.length===0){
        tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>`;
        return;
    }

    filtered.forEach(r=>{
        let statusClass = "status-none";
        let statusText = "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹";
        if(r.remaining===0){statusClass="status-full"; statusText="Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠÙ‹Ø§";}
        else if(r.remaining>0 && r.remaining<r.total){statusClass="status-partial"; statusText="Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠÙ‹Ø§";}

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.name}</td>
            <td>$${r.total}</td>
            <td>$${r.amount}</td>
            <td>$${r.remaining}</td>
            <td>${r.month}</td>
            <td><span class="status-label ${statusClass}">${statusText}</span></td>
            <td>${r.date}</td>
            <td><button class="print-btn">Ø·Ø¨Ø§Ø¹Ø©</button></td>
        `;

        tr.querySelector(".print-btn").addEventListener("click", ()=>{
            const win = window.open("", "PrintReceipt", "width=220,height=500");
            win.document.write(`
            <div style="font-family:Arial;direction:rtl;width:200px;padding:5px;text-align:right;font-size:12px;">
                <h3 style="text-align:center;margin:0;">FAST NET</h3>
                 <p style="text-align:center; margin:2px 0; font-size:12px;">71-338640   ğŸ“  71-346411</p>
                <hr>
                <table style="width:100%;border-collapse:collapse;font-size:12px;direction:rtl;">
                    <tr><td>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</td><td>${r.id}</td></tr>
                    <tr><td>Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</td><td>${r.name}</td></tr>
                    <tr><td>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</td><td>${r.address}</td></tr>
                    <tr><td>Ø³Ø¹Ø±Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ:</td><td>$${r.total}</td></tr>
                    <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</td><td>$${r.amount}</td></tr>
                    <tr><td>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</td><td>$${r.remaining}</td></tr>
                    <tr><td>Ø§Ù„Ø´Ù‡Ø±:</td><td>${r.month}</td></tr>
                    <tr><td>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</td><td>${statusText}</td></tr>
                    <tr><td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹:</td><td>${r.date}</td></tr>
                </table>
                <hr>
                <p style="text-align:center;font-weight:bold;font-size:12px;"></p>
            </div>
            `);
            win.print();
        });

        tableBody.appendChild(tr);
    });
}

// Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ±
searchInput.addEventListener("input", renderTable);
filterSelect.addEventListener("change", renderTable);

// Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ø¶Ù…ÙˆÙ† 100%
function goHome(){
    window.location.href = "https://mahdimaaouch97-cpu.github.io/";
}
</script>

</body>
</html>
